# RHCS 9.x Tier-2 RGW regression test suite for RGW daemon.

# Runs the Object Gateway tests from the repo
# https://github.com/red-hat-storage/ceph-qe-scripts/tree/master/rgw
# global-conf: conf/tentacle/rgw/tier-0_rgw.yaml

tests:
  - test:
      abort-on-fail: true
      desc: Install software pre requisites for cluster deployment
      module: install_prereq.py
      name: setup pre requisites

  - test:
      abort-on-fail: true
      config:
        verify_cluster_health: true
        steps:
          - config:
              command: bootstrap
              service: cephadm
              args:
                registry-url: registry.redhat.io
                mon-ip: node1
                orphan-initial-daemons: true
                skip-monitoring-stack: true
                initial-dashboard-password: admin@123
                dashboard-password-noupdate: true
          - config:
              command: add_hosts
              service: host
              args:
                attach_ip_address: true
                labels: apply-all-labels
          - config:
              command: apply
              service: mgr
              args:
                placement:
                  label: mgr
          - config:
              command: apply
              service: mon
              args:
                placement:
                  label: mon
          - config:
              command: apply
              service: osd
              args:
                all-available-devices: true
          - config:
              command: apply
              service: rgw
              pos_args:
                - rgw.all
              args:
                placement:
                  label: rgw
                  nodes:
                    - node3
                    - node4
                    - node5
      desc: RHCS cluster deployment using cephadm
      destroy-cluster: false
      module: test_cephadm.py
      name: deploy cluster
      polarion-id: CEPH-83573713

  - test:
      name: Monitoring Services deployment
      desc: Add monitoring services using spec file
      module: test_cephadm.py
      polarion-id: CEPH-83574727
      config:
        steps:
          - config:
              command: apply_spec
              service: orch
              validate-spec-services: true
              specs:
                - service_type: prometheus
                  placement:
                    count: 1
                    nodes:
                      - node1
                - service_type: grafana
                  placement:
                    nodes:
                      - node1
                - service_type: alertmanager
                  placement:
                    count: 1
                - service_type: node-exporter
                  placement:
                    host_pattern: "*"
                - service_type: crash
                  placement:
                    host_pattern: "*"

  - test:
      abort-on-fail: true
      config:
        command: add
        id: client.1
        node: node6
        install_packages:
          - ceph-common
        copy_admin_keyring: true
      desc: Configure the RGW client system
      destroy-cluster: false
      module: test_client.py
      name: configure client
      polarion-id: CEPH-83573758
  # Multifactor Authentication tests

  - test:
      name: multipart versioned object deletion with mfa token
      desc: test multipart versioned object deletion with mfa token
      polarion-id: CEPH-83574411
      module: sanity_rgw.py
      config:
        test-version: v2
        script-name: test_rgw_mfa.py
        config-file-name: test_rgw_mfa_multipart.yaml
        extra-pkgs:
          - oathtool

  - test:
      name: incorrect syntax for mfa resync commnad appropriate usage message is displayed
      desc: test with incorrect syntax for mfa resync commnad appropriate usage message is displayed
      polarion-id: CEPH-83574412
      module: sanity_rgw.py
      config:
        test-version: v2
        script-name: test_rgw_mfa.py
        config-file-name: test_rgw_mfa_incorrect_syntax.yaml

  - test:
      name: Test s3 copy obj on user with admin flag through AWS
      desc: TESCO Segfault with s3CopyObj with admin user
      polarion-id: CEPH-83575562
      module: sanity_rgw.py
      config:
        script-name: ../aws/test_sts_rename_large_object.py
        config-file-name: ../../aws/configs/test_s3copyObj_admin_user.yaml

  # testing rgw through curl

  - test:
      name: Test rgw bucket quota using CURL
      desc: Test rgw bucket quota using CURL
      polarion-id: CEPH-83575572
      module: sanity_rgw.py
      config:
        script-name: ../curl/test_quota_using_curl.py
        config-file-name: ../../curl/configs/test_quota_mgmt_bucket_quota_using_curl.yaml

  - test:
      name: Test rgw put object through curl using transfer_encoding chunked
      desc: Test rgw put object through curl using transfer_encoding chunked
      polarion-id: CEPH-83575572
      module: sanity_rgw.py
      config:
        script-name: ../curl/test_rgw_using_curl.py
        config-file-name: ../../curl/configs/test_curl_transfer_encoding_chunked.yaml
  - test:
      name: Test rgw user quota using CURL
      desc: Test rgw user quota using CURL
      polarion-id: CEPH-83575572
      module: sanity_rgw.py
      config:
        script-name: ../curl/test_quota_using_curl.py
        config-file-name: ../../curl/configs/test_quota_mgmt_user_quota_using_curl.yaml
  - test:
      name: Test rgw bucket quota conflict using CURL
      desc: Test rgw bucket quota conflict using CURL
      polarion-id: CEPH-83575572
      module: sanity_rgw.py
      config:
        script-name: ../curl/test_quota_using_curl.py
        config-file-name: ../../curl/configs/test_quota_mgmt_conflict_bucket_quota_using_curl.yaml
  - test:
      name: Test rgw user capability user-info-without-keys using curl
      desc: Test rgw user capability user-info-without-keys using curl
      polarion-id: CEPH-83582351
      module: sanity_rgw.py
      config:
        script-name: ../curl/test_rgw_using_curl.py
        config-file-name: ../../curl/configs/test_rgw_user_cap_user_info_without_keys.yaml

  - test:
      name: Test bucket listing is not truncated
      desc: Test bucket listing is not truncated
      polarion-id: CEPH-83575816
      module: sanity_rgw.py
      config:
        script-name: test_bucket_listing.py
        config-file-name: test_bucket_list_not_truncated.yaml

  - test:
      name: Test user modify with placement id
      desc: Test user modify with placement id
      polarion-id: CEPH-83575880
      module: sanity_rgw.py
      config:
        script-name: user_create.py
        config-file-name: test_user_modify_with_placementid.yaml

  # Checksum and CORS tests
  - test:
      name: Test Checksum on all supported algorithms
      desc: Test Checksum on all supported algorithms
      polarion-id: CEPH-83591679
      module: sanity_rgw.py
      config:
        run-on-rgw: true
        script-name: ../aws/test_checksum.py
        config-file-name: ../../aws/configs/test_checksum_api.yaml

  - test:
      name: Test Checksum which is wrongly computed
      desc: Test Checksum which is wrongly computed
      polarion-id: CEPH-83591699
      module: sanity_rgw.py
      config:
        run-on-rgw: true
        script-name: ../aws/test_checksum.py
        config-file-name: ../../aws/configs/test_wrong_checksum.yaml

  - test:
      name: Test CORS Feature
      desc: Test CORS feature
      polarion-id: CEPH-10355
      module: sanity_rgw.py
      config:
        run-on-rgw: true
        script-name: ../curl/test_cors_using_curl.py
        config-file-name: ../../curl/configs/test_cors_using_curl.yaml

  - test:
      name: Test CRLF Injection
      desc: Test CRLF Injection
      polarion-id: CEPH-83574745
      module: sanity_rgw.py
      config:
        run-on-rgw: true
        script-name: ../curl/test_cors_using_curl.py
        config-file-name: ../../curl/configs/test_crlf_injection_curl.yaml

  - test:
      name: LC process with versioning suspended bucket
      desc: LC process with versioning suspended bucket
      polarion-id: CEPH-83574809
      module: sanity_rgw.py
      config:
        test-version: v2
        script-name: test_bucket_lifecycle_object_expiration_transition.py
        config-file-name: test_lc_process_with_versioning_suspended.yaml

  # Keystone Integration
  - test:
      name: Verify unified namespace for S3 and swift
      desc: Verify unified namespace for S3 and swift
      polarion-id: CEPH-83572907
      module: sanity_rgw.py
      config:
        script-name: ../aws/test_unified_namespace.py
        config-file-name: ../../aws/configs/test_unified_namespace.yaml

  - test:
      name: test keystone integration with RGW
      desc: test keystone integration with RGW
      polarion-id: CEPH-10169
      module: sanity_rgw.py
      config:
        script-name: ../aws/test_keystone_auth.py
        config-file-name: ../../aws/configs/test_keystone_integration.yaml

  # Keystone Integration ACL Test
  - test:
      name: test keystone acl with RGW
      desc: test keystone acl with RGW
      polarion-id: CEPH-83572657
      module: sanity_rgw.py
      config:
        script-name: ../s3_swift/test_swift_acl_with_keystone.py
        config-file-name: ../../s3_swift/configs/test_swift_acl_with_keystone.yaml

  - test:
      name: test bi purge for a bucket
      desc: test bi purge should not error
      module: sanity_rgw.py
      polarion-id: CEPH-83575234
      config:
        script-name: test_Mbuckets_with_Nobjects.py
        config-file-name: test_bi_purge.yaml

  - test:
      name: Indexless buckets
      desc: Indexless blind buckets
      polarion-id: CEPH-10354 # also applies to CEPH-10357
      module: sanity_rgw.py
      config:
        test-version: v2
        script-name: test_indexless_buckets.py
        config-file-name: test_indexless_buckets_s3.yaml

  # Swift Static Large Object
  - test:
      name: test swift static large object expiration
      desc: test swift static large object expiration
      polarion-id: CEPH-9726
      module: sanity_rgw.py
      config:
        script-name: ../s3_swift/test_swift_static_large_object_expiration.py
        config-file-name: ../../s3_swift/configs/test_swift_slo_expiry.yaml
