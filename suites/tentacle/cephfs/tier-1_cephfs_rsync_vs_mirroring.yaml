#===============================================================================================
# Tier-level: 1
# Test-Suite: tier-1_cephfs_mirror.yaml
# Test-Case: Configure CephFS Mirror setup and run IOs
#
# Cluster Configuration:
#    No of Clusters : 2
#    Cluster 1 :
#    3 MONS, 2 MGR, 2 MDS, 3 OSD and 1 CEPHFS MIRROR, 1 Client service daemon(s)
#     Node1 - Mon, Mgr, Installer
#     Node2 - Mon, Mgr
#     Node3 - Mon, OSD
#     Node4 - OSD,MDS
#     Node5 - OSD, MDS
#     Node6 - CephFS Mirror
#     Node7 - Client
#    Cluster 2 :
#    3 MONS, 2 MGR, 2 MDS, 3 OSD and 1 Client service daemon(s)
#     Node1 - Mon, Mgr, Installer
#     Node2 - Mon, Mgr
#     Node3 - Mon, OSD
#     Node4 - OSD,MDS
#     Node5 - OSD, MDS
#     Node6 - Client

#===============================================================================================
tests:
  - test:
      name: setup install pre-requisistes
      desc: Setup phase to deploy the required pre-requisites for running the tests.
      module: install_prereq.py
      abort-on-fail: true
  - test:
      abort-on-fail: true
      clusters:
        ceph1:
          config:
            verify_cluster_health: true
            steps:
              - config:
                  command: bootstrap
                  service: cephadm
                  args:
                    registry-url: registry.redhat.io
                    mon-ip: node1
                    orphan-initial-daemons: true
                    skip-monitoring-stack: true
              - config:
                  command: add_hosts
                  service: host
                  args:
                    attach_ip_address: true
                    labels: apply-all-labels
              - config:
                  command: apply
                  service: mgr
                  args:
                    placement:
                      label: mgr
              - config:
                  command: apply
                  service: mon
                  args:
                    placement:
                      label: mon
              - config:
                  command: apply
                  service: osd
                  args:
                    all-available-devices: true
              - config:
                  command: shell
                  args: # arguments to ceph orch
                    - "ceph fs volume create cephfs"
              - config:
                  command: apply
                  service: mds
                  base_cmd_args: # arguments to ceph orch
                    verbose: true
                  pos_args:
                    - cephfs                        # name of the filesystem
                  args:
                    placement:
                      nodes:
                        - node4
                        - node5
              - config:
                  command: apply
                  service: cephfs-mirror
                  args:
                    placement:
                      nodes:
                        - node6
        ceph2:
          config:
            verify_cluster_health: true
            steps:
              - config:
                  command: bootstrap
                  service: cephadm
                  args:
                    registry-url: registry.redhat.io
                    mon-ip: node1
                    orphan-initial-daemons: true
                    skip-monitoring-stack: true
              - config:
                  command: add_hosts
                  service: host
                  args:
                    attach_ip_address: true
                    labels: apply-all-labels
              - config:
                  command: apply
                  service: mgr
                  args:
                    placement:
                      label: mgr
              - config:
                  command: apply
                  service: mon
                  args:
                    placement:
                      label: mon
              - config:
                  command: apply
                  service: osd
                  args:
                    all-available-devices: true
              - config:
                  command: shell
                  args:                             # arguments to ceph orch
                    - "ceph fs volume create cephfs"
              - config:
                  command: apply
                  service: mds
                  base_cmd_args:                    # arguments to ceph orch
                    verbose: true
                  pos_args:
                    - cephfs                        # name of the filesystem
                  args:
                    placement:
                      nodes:
                        - node4
                        - node5
      desc:  CephFS Mirror cluster deployment using cephadm
      destroy-cluster: false
      module: test_cephadm.py
      polarion-id: CEPH-83574114
      name: deploy cephfs-mirror
  - test:
        abort-on-fail: true
        clusters:
          ceph1:
            config:
              command: add
              copy_admin_keyring: true
              id: client.1
              install_packages:
                - ceph-common
                - ceph-fuse
              node: node7
          ceph2:
            config:
              command: add
              copy_admin_keyring: true
              id: client.1
              install_packages:
                - ceph-common
                - ceph-fuse
              node: node6
        desc: "Configure the Cephfs client system 1"
        destroy-cluster: false
        module: test_client.py
        name: "configure client"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for single large file -> kernel mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for single large file with kernel mount
            mount_type: kernel
            subvol: subvol_1
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_large_files.py
      name: Perform rsync vs mirroring test for single large file with kernel mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for single large file -> fuse mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for single large file with fuse mount
            mount_type: fuse
            subvol: subvol_2
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_large_files.py
      name: Perform rsync vs mirroring test for single large file with fuse mount
      polarion-id: "CEPH-83632239"

  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for single large file -> nfs mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for single large file with nfs mount
            mount_type: nfs
            subvol: subvol_3
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_large_files.py
      name: Perform rsync vs mirroring test for single large file with nfs mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for multiple large file -> kernel mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for multiple large file with kernel mount
            mount_type: kernel
            subvol: subvol_4
            no_of_large_files: 5
            file_block_counts: 1024
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_large_files.py
      name: Perform rsync vs mirroring test for multiple large file with kernel mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for multiple large file -> fuse mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for multiple large file with fuse mount
            mount_type: fuse
            subvol: subvol_5
            no_of_large_files: 5
            file_block_counts: 1024
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_large_files.py
      name: Perform rsync vs mirroring test for multiple large file with fuse mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for multiple large file -> nfs mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for multiple large file with nfs mount
            mount_type: nfs
            subvol: subvol_6
            no_of_large_files: 5
            file_block_counts: 1024
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_large_files.py
      name: Perform rsync vs mirroring test for multiple large file with nfs mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for 1M to 10M sized files -> kernel mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for 1M to 10M sized files with kernel mount
            mount_type: kernel
            subvol: subvol7
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_mib_files.py
      name: Perform rsync vs mirroring test for 1M to 10M sized files with kernel mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for 1M to 10M sized files -> fuse mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for 1M to 10M sized files with fuse mount
            mount_type: fuse
            subvol: subvol8
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_mib_files.py
      name: Perform rsync vs mirroring test for 1M to 10M sized files with fuse mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for 1M to 10M sized files -> nfs mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for 1M to 10M sized files with nfs mount
            mount_type: nfs
            subvol: subvol9
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_mib_files.py
      name: Perform rsync vs mirroring test for 1M to 10M sized files with nfs mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for 1K to 64K sized files -> kernel mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for 1K to 64K sized files with kernel mount
            mount_type: kernel
            subvol: subvol_10
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_kib_files.py
      name: Perform rsync vs mirroring test for 1K to 64K sized files with kernel mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for 1K to 64K sized files -> fuse mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for 1K to 64K sized files with fuse mount
            mount_type: fuse
            subvol: subvol_11
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_kib_files.py
      name: Perform rsync vs mirroring test for 1K to 64K sized files with fuse mount
      polarion-id: "CEPH-83632239"
  - test:
      abort-on-fail: false
      desc: "Perform rsync vs mirroring test for 1K to 64K sized files -> nfs mount"
      clusters:
        ceph1:
          config:
            name: Perform rsync vs mirroring test for 1K to 64K sized files with nfs mount
            mount_type: nfs
            subvol: subvol_12
      module: cephfs_mirroring.test_cephfs_mirroring_vs_rsync_kib_files.py
      name: Perform rsync vs mirroring test for 1K to 64K sized files with nfs mount
      polarion-id: "CEPH-83632239"
