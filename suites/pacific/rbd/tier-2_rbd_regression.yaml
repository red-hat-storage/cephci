# Tier2: Extended RBD acceptance testing
#
# This test suite runs addition test scripts to evaluate the existing functionality of
# Ceph RBD component.
#
# Conf File - conf/pacific/rbd/tier-0_rbd.yaml
#
# The following tests are covered
#   - CEPH-9230 - verification snap and clone on an imported image
#   - CEPH-83573308, CEPH-83573307 - clones creation with v2clone format and deletion
#   - CEPH-83573289 - Verify force remove on trash images
#   - CEPH-83573298 - Move images to trash, restore them and verify
tests:

  # Setup the cluster
  - test:
      abort-on-fail: true
      module: install_prereq.py
      name: install ceph pre-requisites

  - test:
      abort-on-fail: true
      config:
        verify_cluster_health: true
        steps:
          - config:
              command: bootstrap
              service: cephadm
              args:
                mon-ip: node1
                orphan-initial-daemons: true
                skip-monitoring-stack: true
          - config:
              command: add_hosts
              service: host
              args:
                attach_ip_address: true
                labels: apply-all-labels
          - config:
              command: apply
              service: mgr
              args:
                placement:
                  label: mgr
          - config:
              command: apply
              service: mon
              args:
                placement:
                  label: mon
          - config:
              command: apply
              service: osd
              args:
                all-available-devices: true
          - config:
              command: apply
              service: rgw
              pos_args:
                - rgw.1
              args:
                placement:
                  label: rgw
      desc: RHCS cluster deployment using cephadm
      destroy-clster: false
      module: test_cephadm.py
      name: deploy cluster

  # Test cases to be executed

  - test:
      abort-on-fail: true
      config:
        command: add
        id: client.1
        node: node6
        install_packages:
          - ceph-common
          - fio
        copy_admin_keyring: true
      desc: Configure client node
      destroy-cluster: false
      module: test_client.py
      name: configure client

  - test:
      desc: snap and clone operations on imported image
      destroy-cluster: false
      module: rbd_snap_clone_imported_image.py
      name: snap and clone on imported image
      polarion-id: CEPH-9230

  - test:
      desc: Verify Delayed deletion with exclusive feature on RBD image
      module: rbd_exclusive_lock_rm_image.py
      config:
        io-total: 5G
      name: Verify exclusive lock feature
      polarion-id: CEPH-11408

  - test:
      desc: verify for parent image deletion after flattening the clone and removing snap
      config:
        io-total: 5G
      module: rbd_clone_delete_parent_image.py
      name: Test for parent image deletion after flattening the clone and removing snap
      polarion-id: CEPH-11409

  - test:
      desc: Verify that clones creation and deletion of parent image with V2 enabled
      destroy-cluster: false
      module: rbd_clonev2.py
      name: clones creation with v2clone format
      polarion-id: CEPH-83573309

  - test:
      desc: Verify parent snapshot deletion after flattening the clone
      destroy-cluster: false
      module: rbd_clone_delete_parent_snapshot.py
      name: parent snap deletion after clone flattening
      polarion-id: CEPH-83573650

  - test:
      desc: Enable "rbd_move_to_trash_on_remove" config setting, delete images and check if they are moved to trash automatically
      destroy-cluster: false
      config:
        enable: true
      module: rbd_trash.py
      name: Check trash if the deleted images are moved to trash automatically
      polarion-id: CEPH-83573297

  - test:
      desc: Disable "rbd_move_to_trash_on_remove" config setting, delete images and check if they are not moved to trash automatically
      destroy-cluster: false
      config:
        enable: false
      module: rbd_trash.py
      name: Disable Trash and Delete images and check if they are not moved to trash automatically
      polarion-id: CEPH-83573296

  - test:
      desc: Verify force remove on trash images
      destroy-cluster: false
      module: rbd_trash_remove.py
      name: Test force remove on trash images
      polarion-id: CEPH-83573289

  - test:
      desc: Move images to trash, restore them and verify
      destroy-cluster: false
      module: trash_restore.py
      name: Check trash restore functionality
      polarion-id: CEPH-83573298

  - test:
      desc: Move image to trash restore back and try create snap and clone on restored image
      module: trash_restore_create_clone_snap.py
      name: Test snap and clone creation on restored image from trash
      polarion-id: CEPH-11413

  - test:
      desc: Verify parent-clone relationship and clone IOs are not affected when parent moved to trash
      module: rbd_trash_restore_image_having_clone.py
      name: Test parent trash restore with clone IOs
      polarion-id: CEPH-11414

  - test:
      desc: Rename image snapshots on an image on replicated and ecpools and its clones
      module: rbd_snapshot_rename.py
      name: Test Snapshot Rename functionality
      polarion-id: CEPH-9833

  - test:
      desc: Rename image snapshot from which another image was cloned on a replicated and ecpool
      module: rbd_rename_cloned_snapshot.py
      name: Test Snapshot Rename for snapshot with clone
      polarion-id: CEPH-9835

  - test:
      desc: Rename image snapshot when operations on clone/parent image is in progress
      module: rbd_snapshot_rename_advanced.py
      name: Test Snapshot Rename with clone operations in progress
      polarion-id: CEPH-9836

  - test:
      desc: Image migration from two different EC pools to EC pool
      module: rbd_migration_2diff_ec_pool_ec.py
      name: Test image migration on ecpool with different K_m values
      polarion-id: CEPH-83573322

  - test:
      desc: Trying to delete a protected snapshot should fail - negative
      config:
        do_not_create_image: True
        operations:
          map: true
          io: true
          nounmap: true
      module: rbd_delete_protected_snapshot_krbd.py
      name: krbd client - Test to Perform Deletion of protected snapshot
      polarion-id: CEPH-9224

  - test:
      desc: Image migration from replication pools to replication pool
      module: rbd_image_migration.py
      config:
        source:
          rep-pool-only: True
          rep_pool_config:
            pool: rbd_RepPool1
            image: rbd_image
            size: 10G
        destination:
          rep-pool-only: True
          do_not_create_image: True
          rep_pool_config:
            pool: rbd_RepPool2
      name: Test image migration on replication pool
      polarion-id: CEPH-83573293

  - test:
      desc: Image migration from EC pool to EC pool with default K_m value
      module: rbd_image_migration.py
      config:
        source:
          ec-pool-only: True
          ec-pool-k-m: "2,2"
          crush-failure-domain: osd
          ec_pool_config:
            pool: rbd_ECpool1
            image: rbd_image_ec1
            data_pool: data_pool_ec1
            size: 10G
        destination:
          ec-pool-only: True
          ec-pool-k-m: "2,2"
          do_not_create_image: True
          crush-failure-domain: osd
          ec_pool_config:
            pool: rbd_ECpool2
            data_pool: data_pool_ec2
      name: Test image migration on EC pool with default k_m value
      polarion-id: CEPH-83573327

  - test:
      desc: Abort image migration from source to destination pool
      module: rbd_abort_image_migration.py
      config:
        source:
          ec-pool-k-m: "2,2"
          crush-failure-domain: osd
          rep_pool_config:
            pool: rbd_RepPool1
            image: rbd_image
            size: 10G
          ec_pool_config:
            pool: rbd_ECpool1
            image: rbd_image_ec1
            data_pool: data_pool_ec1
            size: 10G
        destination:
          ec-pool-k-m: "2,2"
          do_not_create_image: True
          crush-failure-domain: osd
          rep_pool_config:
            pool: rbd_RepPool2
          ec_pool_config:
            pool: rbd_ECpool2
            data_pool: data_pool_ec2
      name: Test abort image migration from source to destination pool
      polarion-id: CEPH-83573324

  - test:
      desc: Setting up RGW user for s3 image migration test
      module: exec.py
      name: Setup rgw s3 user
      config:
        commands:
          - "radosgw-admin user create --uid=test_rbd --display_name='test_rbd' --access-key test_rbd --secret test_rbd"

  - test:
      name: Image migration from s3 source
      desc: Export an image to s3 source and reinstall as new image using migration
      module: test_rbd_migration_image_s3_object.py
      polarion-id: CEPH-83574092
      config:
        ec_pool_config:
          pool: rbd_pool
          data_pool: rbd_ec_pool
          image: rbd_image
          size: 100M
        rep_pool_config:
          pool: rbd_pool
          image: rbd_rep_image
          size: 100M

  - test:
      desc: Disable the image features on image when image is moved to trash and verify
      module: rbd_features_disable.py
      name: Test to disable the image features on image when image is moved to trash
      polarion-id: CEPH-11415

  - test:
      desc: Perform flatten operations while changing the image feature
      config:
        rbd_op_thread_timeout: 120
      module: rbd_flatten_image_feature_disable.py
      name: Test to disable image feature when flatten operation is performed
      polarion-id: CEPH-9862

  - test:
      desc: Perform trash purge on images with clone and images without clone
      module: rbd_trash_purge.py
      config:
        do_not_create_image: True # to prevent initial_rbd_config from creating an image
        no_of_images: 10 # number of images to create for testing
        no_of_clones: 4 # number of images for which clones to be created
      name: Test to perform trash purge on images with and without clone
      polarion-id: CEPH-83574482

  - test:
      desc: Add trash purge schedule and verify the schedule
      module: test_rbd_trash_purge_schedule.py
      name: Test to verify trash purge schedule
      config:
        do_not_create_image: True
      polarion-id: CEPH-83573660

  - test:
      desc: Verify image trash restore when same name image is already present
      module: trash_restore_same_name_image.py
      name: Test to verify image restore with same name
      polarion-id: CEPH-11393

  - test:
      desc: Verify image feature disable on image having image meta set on it
      config:
        image_feature : deep-flatten
      module: image_with_metadata_feature_disable.py
      name: Test to verify image feature disable with image meta on it
      polarion-id: CEPH-9864

  - test:
      desc: Verify image resize while changing image feature
      config:
        image_feature: fast-diff
        size_increase: 11G
        size_decrease: 5G
        rep_pool_config:
          size: 10G
        ec_pool_config:
          size: 10G
      module: rbd_resize_image_with_image_feature.py
      name: Test to verify image resize operation while changing image feature
      polarion-id: CEPH-9861

  - test:
      desc: Image migration from namespace for read-only client
      module: readonly_namespace_image_migration.py
      config:
        source:
          do_not_create_image: True
          rep_pool_config:
            pool: rbd_RepPool1
          ec_pool_config:
            pool: rbd_ECpool1
            data_pool: data_pool_ec1
        destination:
          do_not_create_image: True
          rep_pool_config:
            pool: rbd_RepPool2
          ec_pool_config:
            pool: rbd_ECpool1
            data_pool: data_pool_ec2
      name: Test image migration from namespace for read-only client
      polarion-id: CEPH-83573341

  - test:
      desc: Verify rbd_compression_hint config settings
      config:
        compression_algorithm: snappy
        compression_mode: passive
        compression_ratio: 0.7
        io_total: 1G
      module: test_rbd_compression.py
      name: Test to verify data compression on global, pool and image level
      polarion-id: CEPH-83574644

