#===============================================================================================
# Tier-level: 2
# Test-Suite: test-2_cephmgr.yaml
# Test-Case: Perform operations to validate ceph insights functionality
# Test-Case: Verify cephmgr throttling
#
# Cluster Configuration:
#    conf/pacific/cephmgr/tier-2-cephmgr-4node.yaml
#
#    4-Node cluster
#    3 MONS, 2 MDS, 2 MGR, 3 OSD and 2 RGW service daemon(s)
#
#===============================================================================================
tests:
  - test:
      name: setup install pre-requisistes
      desc: Setup phase to deploy the required pre-requisites for running the tests.
      module: install_prereq.py
      abort-on-fail: true

  - test:
      abort-on-fail: true
      config:
        steps:
          - config:
              command: bootstrap
              service: cephadm
              args:
                mon-ip: node1
          - config:
              command: add_hosts
              service: host
              args:
                attach_ip_address: true
                labels: apply-all-labels
          - config:
              command: apply
              service: osd
              args:
                all-available-devices: true
          - config:
              command: apply
              service: rgw
              pos_args:
                - rgw.1
              args:
                placement:
                  label: rgw
          - config:
              args:
                - "ceph fs volume create cephfs"
              command: shell
          - config:
              args:
                placement:
                  label: mds
              base_cmd_args:
                verbose: true
              command: apply
              pos_args:
                - cephfs
              service: mds
          - config:
              args:
                - "ceph osd pool create rbd"
              command: shell
          - config:
              args:
                - "rbd pool init rbd"
              command: shell
      desc: bootstrap and deploy services.
      destroy-cluster: false
      polarion-id: CEPH-83573713
      module: test_cephadm.py
      name: Deploy cluster using cephadm

  - test:
      name: Enable ceph insights on a ceph cluster
      desc: Enables ceph insights
      polarion-id: CEPH-83573683
      module: test_cephmgr_validate_insights.py
      config:
        operation: enable

  - test:
      name: Run Insights on an existing ceph cluster
      desc: Runs ceph insights command
      polarion-id: CEPH-83573684
      module: test_cephmgr_validate_insights.py
      config:
        operation: run-insight

  - test:
      name: Verify Insights report sections
      desc: Verify report generated by ceph insights
      polarion-id: CEPH-83573685
      module: test_cephmgr_validate_insights.py
      config:
        operation: verify-report

  - test:
      name: Verify Insights report - all available sections
      desc: Verify report generated by ceph insights has required sections
      polarion-id: CEPH-83573687
      module: test_cephmgr_validate_insights.py
      config:
        operation: verify-report-sections

  - test:
      name: Ceph Insights - Delete insights report within an interval
      desc: Verify report deleted after prune-health option with duration
      polarion-id: CEPH-83573688
      module: test_cephmgr_validate_insights.py
      config:
        operation: verify-prune-health

  - test:
      name: Verify disable insights functionality
      desc: Verify ceph insight disable
      polarion-id: CEPH-83573811
      module: test_cephmgr_validate_insights.py
      config:
        operation: disable

  - test:
      name: Verify cephmgr throttling
      desc: Verify cephmgr throttling
      polarion-id: CEPH-83573248
      module: test_cephmgr_throttling
      config:
        operation: enable
        module: balancer
        key: target_max_misplaced_ratio
        value: .07

  - test:
      name: Verify ceph-mgr systemctl ops
      desc: Verify the start, stop and restart operations of
      polarion-id: CEPH-11384
      module: test_cephmgr_validate_mgr_status.py
      config:
        operation: systemctl-ops

  - test:
      name: Verify ceph-mgr after reboot
      desc: Verify the status of mgr after reboot
      polarion-id: CEPH-11388
      module: test_cephmgr_validate_mgr_status.py
      config:
        operation: reboot

  - test:
      name: Verify pre-empt ceph-mgr
      desc: Verify user can pre-empt ceph-mgr using "ceph mgr fail" cmd
      polarion-id: CEPH-11383
      module: test_cephmgr_validate_mgr_status.py
      config:
        operation: fail-mgr

  - test:
      name: Verify standby mgr up when active is down
      desc: Verify when active mgr fails, the standby comes up and cluster health has no warn
      polarion-id: CEPH-11382
      module: test_cephmgr_validate_mgr_status.py
      config:
        operation: kill-mgr

  - test:
      name: Verify dashboard cannot start on non-active ceph-mgrs
      desc: Verify dashboard cannot start on non-active ceph-mgrs
      polarion-id: CEPH-11386
      module: test_cephmgr_dashboard_plugin.py
      config:
        error: RADOS permission denied

  - test:
      name: Verify dashboard plugin works fine with ceph-mgr
      desc: Verify dashboard plugin works fine with ceph-mgr
      polarion-id: CEPH-11385
      module: test_dashboard_plugin_with_ceph_mgr.py

  - test:
      name: Ceph Insights - Monitor log growth on ceph audit log
      desc: Verify log growth to ceph.audit.log during a failure scenario
      polarion-id: CEPH-83573810
      module: test_cephmgr_validate_insights.py
      config:
        operation: verify-log

  - test:
      name: Verify supervised optimisation
      desc: Verify create evaluate execute a plan with supervised optimisation
      polarion-id: CEPH-83573250
      module: test_cephmgr_validate_supervised_optimisation.py
      config:
        mode: upmap

  - test:
      name: Verify supervised optimisation
      desc: Verify create evaluate execute a plan with supervised optimisation
      polarion-id: CEPH-83573249
      module: test_cephmgr_validate_supervised_optimisation.py
      config:
        mode: crush-compat

  - test:
      name: Verify pg autoscaler on with crush rule
      desc: Verify  Module 'pg_autoscaler' has failed 'op' error with crush rule set
      polarion-id: CEPH-83575456
      module: test_cephmgr_validate_crush_rule.py
