# Test suite for for baremetal rgw-multisite deployment and testing multisite sync at scale.
#
# This suite deploys a Longevity environment on baremetal machines. It is a multisite environment with each site having a storage capacity of 617Tb.
# each site has around 4 osd hosts and a total of 16 osds.
# A single realm (India) spanning across two RHCS clusters. It has a
# zonegroup (shared) which also spans across the clusters. There exists a master (primary)
# and secondary (secondary) zone within this group. The master zone is part of the pri
# cluster whereas the sec zone is part of the sec datacenter (cluster).

# The deployment is evaluated by running IOs across the environments.
# tested with conf file: conf/baremetal/extensa_clara_multisite_1admin_4node_1client.yaml

tests:

  - test:
      clusters:
        ceph-pri:
          config:
            controllers:
              - clara001
            drivers: # if drivers are not specified will use one of the rgw node
              - clara001
              - clara011
              - clara012
            fill_percent: 30
      desc: prepare and push cosbench fill workload
      module: push_cosbench_workload.py
      name: push cosbench fill workload
      polarion-id: CEPH-83574428

  - test:
      clusters:
        ceph-pri:
          config:
            controllers:
              - clara001
            drivers: # if drivers are not specified will use one of the rgw node
              - clara001
              - clara011
              - clara012
            fill_percent: 30
            workload_type: hybrid
            run_time: 3600 # value in seconds
      desc: initiate cosbench hybrid workload
      module: push_cosbench_workload.py
      name: push cosbench hybrid workload
      polarion-id: CEPH-83575831

  - test:
      clusters:
        ceph-pri:
          config:
            set-env: true
            script-name: user_create.py
            config-file-name: non_tenanted_user.yaml
            copy-user-info-to-site: ceph-sec
            timeout: 300
      desc: create non-tenanted user
      module: sanity_rgw_multisite.py
      name: create non-tenanted user
      polarion-id: CEPH-83575199

  - test:
      abort-on-fail: true
      clusters:
        ceph-pri:
          config:
            script-name: ../aws/test_aws.py
            config-file-name: ../../aws/configs/test_aws_versioned_bucket_creation.yaml
            verify-io-on-site: ["ceph-sec"]
            timeout: 300
      desc: create versioned bucket in primary
      module: sanity_rgw_multisite.py
      name: create versioned bucket in primary
      polarion-id: CEPH-83575073

  - test:
      name: Parallel upload of objects to versioned bucket
      desc: Parallel upload of objects to versioned bucket
      module: test_parallel.py
      parallel:
        - test:
            clusters:
              ceph-pri:
                config:
                  controllers:
                    - clara001
                  drivers:
                    - clara001
                    - clara011
                    - clara012
                  fill_percent: 35
                  workload_type: symmetrical
                  record_sync_on_site: ceph-sec
                  bucket_prefix: cosbench01-bkt-
                  number_of_buckets: 1
            desc: initiate cosbench push workload from primary
            module: push_cosbench_workload.py
            name: push cosbench push workload from primary
            polarion-id: CEPH-83575073
        - test:
            clusters:
              ceph-sec:
                config:
                  controllers:
                    - clara013
                  drivers:
                    - clara013
                    - clara014
                    - clara015
                  fill_percent: 35
                  workload_type: symmetrical
                  record_sync_on_site: ceph-pri
                  bucket_prefix: cosbench01-bkt-
                  number_of_buckets: 1
            desc: initiate cosbench push workload from secondary
            module: push_cosbench_workload.py
            name: push cosbench push workload from secondary
            polarion-id: CEPH-83575073

  - test:
      clusters:
        ceph-pri:
          config:
            controllers:
              - clara001
            drivers:
              - clara001
              - clara011
              - clara012
            workload_type: fill_runtime
            run_time: 7200
            record_sync_on_site: ceph-sec
            bucket_prefix: cosbench01-bkt-
            number_of_buckets: 1
            number_of_objects: 2000000
      desc: initiate cosbench fill workload for versioned bucket
      name: push cosbench fill workload for versioned bucket
      module: push_cosbench_workload.py
      polarion-id: CEPH-83575077

  - test:
      clusters:
        ceph-pri:
          config:
            cephadm: true
            commands:
              - radosgw-admin bucket sync markers --bucket cosbench01-bkt-1 --source-zone secondary
      desc: Run radosgw-admin bucket sync markers from primary
      name: Run radosgw-admin bucket sync markers from primary
      polarion-id: CEPH-83575077
      module: exec.py

  - test:
      name: Parallel delete of objects from bucket
      desc: Parallel delete of objects from bucket
      module: test_parallel.py
      parallel:
        - test:
            clusters:
              ceph-pri:
                config:
                  controllers:
                    - clara001
                  drivers:
                    - clara001
                    - clara011
                    - clara012
                  workload_type: cleanup
                  record_sync_on_site: ceph-sec
                  bucket_prefix: cosbench01-bkt-
                  number_of_buckets: 1
            desc: initiate cosbench cleanup workload from primary
            module: push_cosbench_workload.py
            name: push cosbench cleanup workload from primary
            polarion-id: CEPH-83575074
        - test:
            clusters:
              ceph-sec:
                config:
                  controllers:
                    - clara013
                  drivers:
                    - clara013
                    - clara014
                    - clara015
                  workload_type: cleanup
                  record_sync_on_site: ceph-pri
                  bucket_prefix: cosbench01-bkt-
                  number_of_buckets: 1
            desc: initiate cosbench cleanup workload from secondary
            module: push_cosbench_workload.py
            name: push cosbench cleanup workload from secondary
            polarion-id: CEPH-83575074
