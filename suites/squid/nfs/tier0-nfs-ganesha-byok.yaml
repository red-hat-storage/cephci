# ===============================================================================
# Test Suite: NFS Ganesha v4.2 with BYOK (Bring Your Own Key)
# Configuration: conf/squid/nfs/1admin-7node-3client.yaml
#
# This suite performs end-to-end testing of:
#   - GKLM integration for key and certificate management (BYOK/KMIP)
#   - Deployment and configuration of NFS Ganesha v4.2
#   - I/O operations validation on NFS exports
#   - Encryption enforcement verification via FUSE mounts
#
# Prerequisites:
#   • CephCI environment configured for your cloud (openstack or baremetal)
#   • GKLM credentials supplied via:
#       a) --custom-config-file <gklm_file.yaml>
#          gklm_file.yaml should include:
#            gklm:
#              gklm_ip:           "0.0.0.0"    # GKLM server IP
#              gklm_user:         "admin"      # GKLM REST API user
#              gklm_password:     "password"   # GKLM REST API password
#              gklm_node_username:"user"       # SSH user on GKLM host
#              gklm_node_password:"password"   # SSH password on GKLM host
#              gklm_hostname:     "myhost"     # GKLM server hostname
#
#       OR
#       b) Multiple --custom-config entries:
#          --custom-config "gklm_ip=0.0.0.0"
#          --custom-config "gklm_user=admin"
#          --custom-config "gklm_password=password"
#          --custom-config "gklm_node_username=user"
#          --custom-config "gklm_node_password=password"
#          --custom-config "gklm_hostname=myhost"
#
#       OR
#       c) In ~/.cephci.yaml under 'gklm_config':
#          gklm_config:
#            openstack:
#              gklm_ip:             "0.0.0.0"
#              gklm_user:           "user"
#              gklm_password:       "password"
#              gklm_node_username:  "user"
#              gklm_node_password:  "password"
#              gklm_hostname:       "hostname"
#            ibmc:
#              gklm_ip:             "0.0.0.0"
#              gklm_user:           "user"
#              gklm_password:       "password"
#              gklm_node_username:  "user"
#              gklm_node_password:  "password"
#              gklm_hostname:       "hostname"
# ===============================================================================

tests:
   - test:
       abort-on-fail: true
       desc: Install software pre-requisites for cluster deployment.
       module: install_prereq.py
       name: setup pre-requisites

   - test:
       abort-on-fail: true
       config:
         steps:
           - config:
               command: bootstrap
               service: cephadm
               args:
                 mon-ip: node1
           - config:
               command: add_hosts
               service: host
               args:
                 attach_ip_address: true
                 labels: apply-all-labels
           - config:
               command: apply
               service: osd
               args:
                 all-available-devices: true
           - config:
               command: apply
               service: rgw
               pos_args:
                 - rgw.1
               args:
                 placement:
                   label: rgw
           - config:
               args:
                 - "ceph fs volume create cephfs"
               command: shell
           - config:
               args:
                 placement:
                   label: mds
               base_cmd_args:
                 verbose: true
               command: apply
               pos_args:
                 - cephfs
               service: mds
           - config:
               args:
                 - "ceph osd pool create rbd"
               command: shell
           - config:
               args:
                 - "rbd pool init rbd"
               command: shell
       desc: bootstrap and deploy services.
       destroy-cluster: false
       polarion-id: CEPH-83573713
       module: test_cephadm.py
       name: Deploy cluster using cephadm

   - test:
       abort-on-fail: true
       config:
         command: add
         id: client.1
         node: node4
         install_packages:
           - ceph-common
           - ceph-fuse
         copy_admin_keyring: true
       desc: Configure the RGW,RBD client system
       destroy-cluster: false
       module: test_client.py
       name: configure client

   - test:
       abort-on-fail: true
       config:
         command: add
         id: client.2
         node: node5
         install_packages:
           - ceph-common
           - ceph-fuse
         copy_admin_keyring: true
       desc: Configure the RGW,RBD client system
       destroy-cluster: false
       module: test_client.py
       name: configure client

   - test:
       abort-on-fail: true
       config:
         command: add
         id: client.3
         node: node6
         install_packages:
           - ceph-common
           - ceph-fuse
         copy_admin_keyring: true
       desc: Configure the RGW,RBD client system
       destroy-cluster: false
       module: test_client.py
       name: configure client

   - test:
       abort-on-fail: true
       config:
         command: add
         id: client.4
         node: node7
         install_packages:
           - ceph-common
           - ceph-fuse
         copy_admin_keyring: true
       desc: Configure the RGW,RBD client system
       destroy-cluster: false
       module: test_client.py
       name: configure client

   - test:
       name: Test Encryption with the correct keys
       module: byok.test_byok_with_io_fuse_validation.py
       desc: byok Encryption with the correct keys
       polarion-id: CEPH-83625072
       abort-on-fail: true
       config:
         nfs_version: 4.2
         total_export_num: 4
         clients: 1
